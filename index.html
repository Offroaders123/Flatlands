<!DOCTYPE html>
<html lang="en-US">

<head>

<title>Flatlands</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  *, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  html {
    width: 100%;
    height: 100%;
    overflow: hidden;
  }
  body {
    position: fixed;
    width: 100%;
    height: 100%;
    display: flex;
    font-family: sans-serif;
    overflow: auto;
    -webkit-user-select: none;
    user-select: none;
  }
  #canvas {
    margin: auto;
    width: 100%;
    height: 100%;
    image-rendering: pixelated;
  }
</style>

</head>

<body>

<canvas id="canvas"></canvas>

<script>
// Canvas setup
const canvas = document.querySelector("#canvas");
const ctx = canvas.getContext("2d");
canvas.width = canvas.offsetWidth;
canvas.height = canvas.offsetHeight;

const baseDimensions = canvas.getBoundingClientRect();

new ResizeObserver(() => {
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  animate(false);
}).observe(canvas);

let gameFrame = 0;

// Interactivity
const key = {
  left: false,
  right: false,
  up: false,
  down: false
};
document.addEventListener("keydown",event => {
  if (event.repeat) return;
  if (["ArrowLeft","a"].includes(event.key)) key.left = true;
  if (["ArrowRight","d"].includes(event.key)) key.right = true;
  if (["ArrowUp","w"].includes(event.key)) key.up = true;
  if (["ArrowDown","s"].includes(event.key)) key.down = true;
});
document.addEventListener("keyup",event => {
  if (["ArrowLeft","a"].includes(event.key)) key.left = false;
  if (["ArrowRight","d"].includes(event.key)) key.right = false;
  if (["ArrowUp","w"].includes(event.key)) key.up = false;
  if (["ArrowDown","s"].includes(event.key)) key.down = false;
});
document.addEventListener("contextmenu",event => event.preventDefault());

// Environment
const grassSprite = new Image();
grassSprite.src = "https://i.pinimg.com/originals/49/79/a4/4979a491071109b22a41faba62caffed.jpg";
let grassPattern;
grassSprite.addEventListener("load",() => grassPattern = ctx.createPattern(grassSprite,"repeat"));

const explored = {
  left: 0,
  right: canvas.width,
  top: 0,
  bottom: canvas.height
};

// Player
class Player {
  constructor(){
    this.x = 0;
    this.y = 0;
    this.width = 64;
    this.height = 128;
    this.speed = 10;
  }
  update(){
    if (key.left) this.x += this.speed;
    if (key.right) this.x -= this.speed;
    if (key.up) this.y += this.speed;
    if (key.down) this.y -= this.speed;
  }
  draw(){
    ctx.fillStyle = "red";
    ctx.fillRect(Math.round(canvas.width / 2) - this.width / 2,Math.round(canvas.height / 2) - this.height / 2,this.width,this.height);
  }
}
const player = new Player();

// Trees
const treesArray = [];
class Tree {
  constructor(){
    this.x = Math.floor(Math.random() * canvas.width) - player.x;
    if (key.up){
      this.y = canvas.height / -2 - player.y;
      if (explored.top > this.y){ explored.top = this.y;console.log(explored.top)}
    }
    if (key.down){
      this.y = canvas.height - player.y;
      if (explored.bottom < this.y){ explored.bottom = this.y;console.log(explored.bottom)}
    }
    this.width = 128;
    this.height = 256;
  }
  draw(){
    ctx.fillStyle = "green";
    ctx.fillRect(this.x + player.x,this.y + player.y,this.width,this.height);
  }
}
function handleTrees(){
  if (gameFrame % 20 == 0){
    if (canvas.height / -2 - player.y < explored.top || canvas.height - player.y > explored.bottom){
      treesArray.push(new Tree());
    }
  }
  treesArray.forEach(tree => {
    tree.draw();
  });
}

// Set random label
let randomLabel;
function setRandomLabel(){
  if (gameFrame % 10 == 0) randomLabel = Math.floor(Math.random() * 10);
  ctx.fillStyle = "black";
  ctx.font = "40px sans-serif";
  ctx.fillText(`random: ${randomLabel}`,Math.round(canvas.width / 2) - Math.round(baseDimensions.width / 2) + player.x + 20,Math.round(canvas.height / 2) - Math.round(baseDimensions.height / 2) + player.y + 50);
}

// Set coordinate label
function setCoordinateLabel(){
  ctx.fillStyle = "black";
  ctx.font = "20px monospace";
  ctx.fillText(`x: ${Math.round(player.x / 10) * -1}, y: ${Math.round(player.y / 10)}`,12,canvas.height - 16);
}

// Animation loop
function animate(recursive = true){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (grassPattern) grassPattern.setTransform(new DOMMatrix([1,0,0,1,Math.round(canvas.width / 2) + player.x,Math.round(canvas.height / 2) + player.y]));
  ctx.fillStyle = (grassPattern) ? grassPattern : "#7e892a";
  //ctx.fillStyle = "green";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  handleTrees();
  player.update();
  player.draw();
  setRandomLabel();
  setCoordinateLabel();
  gameFrame++;
  if (recursive) window.requestAnimationFrame(animate);
}
animate();
</script>

</body>

</html>