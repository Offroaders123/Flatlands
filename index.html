<!DOCTYPE html>
<html lang="en-US">

<head>

<title>Flatlands</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="author" content="Brandon Bennett">
<meta name="description" content="Flatlands is a cross platform 2D game built in the browser!">
<meta property="og:title" content="Flatlands">
<meta property="og:description" content="Flatlands is a cross platform 2D game built in the browser!">
<meta property="og:image" content="https://offroaders123.github.io/Flatlands/Flatlands.png">
<meta property="og:url" content="https://offroaders123.github.io/Flatlands/">
<meta name="twitter:card" content="summary_large_image">
<meta name="theme-color" content="#779c43">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Flatlands">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<base href="https://offroaders123.github.io/Flatlands/">
<link rel="canonical" href="https://offroaders123.github.io/Flatlands/">
<!--link rel="manifest">
<link rel="icon" type="image/svg+xml" href="resources/icon.svg"-->
<link rel="alternate icon" type="image/png" sizes="16x16" href="spearsword.png">
<!--link rel="alternate icon" type="image/png" sizes="32x32" href="resources/icon-32.png">
<link rel="apple-touch-icon" sizes="180x180" href="resources/app-apple-touch-180.png">
<link rel="apple-touch-icon" sizes="1024x1024" href="resources/app-apple-touch-1024.png"-->

<script>
  window.Flatlands = {
    appearance: () => ({
      apple_home_screen: (/(Mac|iPhone|iPad|iPod)/i.test(navigator.platform) && "standalone" in navigator && navigator.standalone)
    }),
    environment: () => ({
      touch_device: ("ontouchstart" in window)
    })
  };
  if (Flatlands.appearance().apple_home_screen) document.documentElement.classList.add("apple-home-screen");
  if (Flatlands.environment().touch_device) document.documentElement.classList.add("touch-device");
</script>

<style>
  *, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  :root {
    --safe-area-inset-left: env(safe-area-inset-left,0px);
    --safe-area-inset-right: env(safe-area-inset-right,0px);
    --safe-area-inset-top: env(safe-area-inset-top,0px);
    --safe-area-inset-bottom: env(safe-area-inset-bottom,0px);
  }
  html {
    width: 100%;
    height: 100%;
    overflow: hidden;
  }
  html.apple-home-screen {
    width: 100vw;
    height: 100vh;
  }
  body {
    position: fixed;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: sans-serif;
    image-rendering: pixelated;
    overflow: auto;
    -webkit-user-select: none;
    user-select: none;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
  #canvas {
    margin: auto;
    width: 100%;
    height: 100%;
  }
  #coordinates {
    margin: 12px;
    position: fixed;
    left: var(--safe-area-inset-left);
    top: var(--safe-area-inset-top);
    color: #ffffff;
    font-size: 20px;
    font-family: monospace;
    line-height: 1;
    text-shadow: 2px 2px 0 #000000;
  }
  #hotbar {
    padding: 4px;
    position: fixed;
    bottom: calc(var(--safe-area-inset-bottom));
    display: flex;
    list-style: none;
  }
  #hotbar .slot {
    margin: 4px;
    padding: 8px;
    display: flex;
    background: url("slot.png") no-repeat;
    background-size: cover;
  }
  #hotbar .item {
    width: min(min(12vh,8vw),64px);
    height: min(min(12vh,8vw),64px);
  }
  #dpad {
    margin: 16px;
    position: fixed;
    left: calc(var(--safe-area-inset-left));
    bottom: calc(var(--safe-area-inset-bottom));
    display: grid;
    grid-template-areas:
      ". up ."
      "left . right"
      ". down ."
    ;
  }
  :root:not(.touch-device) #dpad {
    display: none;
  }
  #dpad button {
    width: 48px;
    height: 48px;
  }
  #dpad [data-left] {
    grid-area: left;
  }
  #dpad [data-right] {
    grid-area: right;
  }
  #dpad [data-up] {
    grid-area: up;
  }
  #dpad [data-down] {
    grid-area: down;
  }
</style>

</head>

<body>

<canvas id="canvas"></canvas>
<span id="coordinates"></span>
<ul id="hotbar">
  <li class="slot" data-slot="1">
    <span class="item spearsword"></span>
  </li>
  <li class="slot" data-slot="2">
    <span class="item pickmatic"></span>
  </li>
  <li class="slot active" data-slot="3">
    <span class="item hatchet"></span>
  </li>
  <li class="slot" data-slot="4">
    <span class="item spade"></span>
  </li>
  <li class="slot" data-slot="5">
    <span class="item"></span>
  </li>
  <li class="slot" data-slot="6">
    <span class="item pizza"></span>
  </li>
</ul>
<div id="dpad">
  <button data-left>Left</button>
  <button data-right>Right</button>
  <button data-up>Up</button>
  <button data-down>Down</button>
</div>

<script>
// Canvas
const canvas = document.querySelector("#canvas");
const bounds = canvas.getBoundingClientRect();
const ctx = canvas.getContext("2d",{ alpha: false });

let scaling = 4;

new ResizeObserver(() => {
  canvas.width = canvas.offsetWidth / scaling;
  canvas.height = canvas.offsetHeight / scaling;
  ctx.imageSmoothingEnabled = false;
  animate({ recursive: false });
}).observe(canvas);

let tick = 0;

// Input
const key = {
  left: false,
  right: false,
  up: false,
  down: false
};
document.addEventListener("keydown",event => {
  if (event.repeat || document.activeElement != document.body) return;
  if (["ArrowLeft","a"].includes(event.key)) key.left = true;
  if (["ArrowRight","d"].includes(event.key)) key.right = true;
  if (["ArrowUp","w"].includes(event.key)) key.up = true;
  if (["ArrowDown","s"].includes(event.key)) key.down = true;
});
document.addEventListener("keyup",event => {
  if (document.activeElement != document.body) return;
  if (["ArrowLeft","a"].includes(event.key)) key.left = false;
  if (["ArrowRight","d"].includes(event.key)) key.right = false;
  if (["ArrowUp","w"].includes(event.key)) key.up = false;
  if (["ArrowDown","s"].includes(event.key)) key.down = false;
});
document.addEventListener("contextmenu",event => event.preventDefault());

dpad.addEventListener("touchstart",event => {
  event.preventDefault();
  if (event.target.matches("[data-left]")) key.left = true;
  if (event.target.matches("[data-right]")) key.right = true;
  if (event.target.matches("[data-up]")) key.up = true;
  if (event.target.matches("[data-down]")) key.down = true;
});
dpad.addEventListener("touchend",event => {
  if (event.target.matches("[data-left]")) key.left = false;
  if (event.target.matches("[data-right]")) key.right = false;
  if (event.target.matches("[data-up]")) key.up = false;
  if (event.target.matches("[data-down]")) key.down = false;
});

// Environment
const grassSprite = new Image();
grassSprite.src = "ground.png";
let grassPattern;
grassSprite.addEventListener("load",() => grassPattern = ctx.createPattern(grassSprite,"repeat"));

const explored = {
  left: 0,
  right: canvas.width,
  top: 0,
  bottom: canvas.height
};

// Player
const playerSprite = new Image();
playerSprite.src = "player_guy.png";
class Player {
  constructor(){
    this.x = 0;
    this.y = 0;
    this.width = 16;
    this.height = 32;
    this.offsetX = () => Math.round(canvas.width / 2);
    this.offsetY = () => Math.round(canvas.height / 2);
    this.speed = 2;
    this.tick = 0;
    this.ticks = 24;
    this.frame = 0;
    this.frames = 2;
    this.column = 0;
    this.columns = 4;
  }
  update(){
    if (key.left) this.x += this.speed;
    if (key.right) this.x -= this.speed;
    if (key.up) this.y += this.speed;
    if (key.down) this.y -= this.speed;

    this.tick++;
    if (this.tick > this.ticks - 1){
      this.tick = 0;
      if (this.frame < this.frames - 1){
        this.frame++;
      } else {
        this.frame = 0;
        if (this.column < this.columns - 1){
          this.column++;
        } else {
          this.column = 0;
        }
      }
    }
  }
  draw(){
    ctx.drawImage(playerSprite,this.width * ((this.column != 0) ? this.frame : 0),this.height * this.column,this.width,this.height,this.offsetX() - this.width / 2,this.offsetY() - this.height / 2,this.width,this.height);
  }
}
const player = new Player();

// Trees
const treesArray = [];
const treeSprite = new Image();
treeSprite.src = "tree.png";
class Tree {
  constructor(){
    this.x = Math.floor(Math.random() * canvas.width) - player.x - 96 / 2;
    if (key.up){
      this.y = canvas.height / -2 - player.y - 96 / 2;
      if (explored.top > this.y) explored.top = this.y;
    }
    if (key.down){
      this.y = canvas.height - player.y;
      if (explored.bottom < this.y) explored.bottom = this.y;
    }
    this.width = 96;
    this.height = 150;
  }
  draw(){
    ctx.drawImage(treeSprite,this.x + player.x,this.y + player.y,this.width,this.height);
  }
}
function handleTrees(){
  if (tick % 20 == 0){
    if (canvas.height / -2 - player.y < explored.top || canvas.height - player.y > explored.bottom){
      if (key.up) treesArray.unshift(new Tree());
      if (key.down) treesArray.push(new Tree());
    }
  }
  treesArray.forEach(tree => {
    tree.draw();
  });
}

// Coordinates
const coordinates = document.querySelector("#coordinates");
function setCoordinateLabel(){
  coordinates.textContent = `(${Math.round(player.x / 16) * -1}, ${Math.round(player.y / 16)})`;
}

// Rendering
function animate({ recursive = true } = {}){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (grassPattern) grassPattern.setTransform(new DOMMatrix([1,0,0,1,player.offsetX() + player.x,player.offsetY() + player.y]));
  ctx.fillStyle = (grassPattern) ? grassPattern : "#779c43";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  handleTrees();
  player.update();
  player.draw();
  setCoordinateLabel();
  tick++;
  if (recursive) window.requestAnimationFrame(animate);
}
animate();
</script>

</body>

</html>